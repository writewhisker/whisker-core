name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test with Lua ${{ matrix.lua-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lua-version: ['5.2', '5.3', '5.4']

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Lua
      uses: leafo/gh-actions-lua@v12
      with:
        luaVersion: ${{ matrix.lua-version }}

    - name: Setup LuaRocks
      uses: leafo/gh-actions-luarocks@v6

    - name: Install busted
      run: |
        luarocks install busted --only-server=https://luarocks.org || luarocks install busted

    - name: Install luacov (coverage)
      if: matrix.lua-version == '5.4'
      run: |
        luarocks install luacov --only-server=https://luarocks.org || luarocks install luacov

    - name: Run tests
      run: busted --verbose ${{ matrix.lua-version == '5.4' && '--coverage' || '' }}

    - name: Generate coverage report
      if: matrix.lua-version == '5.4'
      run: luacov

    - name: Upload coverage
      if: matrix.lua-version == '5.4'
      uses: codecov/codecov-action@v5
      with:
        files: ./luacov.report.out
        flags: unittests
        name: codecov-whisker-core

  checks:
    name: Lint, modularity & validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Lua
      uses: leafo/gh-actions-lua@v12
      with:
        luaVersion: '5.4'

    - name: Setup LuaRocks
      uses: leafo/gh-actions-luarocks@v6

    - name: Install luacheck
      run: |
        luarocks install luacheck --only-server=https://luarocks.org || luarocks install luacheck

    - name: Run luacheck
      run: luacheck lib/ bin/ --config .luacheckrc

    - name: Check for modularity bypass
      id: bypass
      run: |
        if git log -1 --pretty=%B | grep -q '\[skip-modularity\]'; then
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "Modularity check bypassed via commit message"
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Run modularity validation
      if: steps.bypass.outputs.skip != 'true'
      run: |
        lua tools/validate_modularity.lua --errors-only --format=ci lib/
        exit_code=$?
        if [ $exit_code -eq 1 ]; then
          echo ""
          echo "::error::Modularity violations detected. Fix the issues above or use [skip-modularity] in commit message to bypass."
          exit 1
        elif [ $exit_code -eq 2 ]; then
          echo "::error::Modularity validator encountered an error"
          exit 1
        fi

    - name: Validate example stories
      run: |
        if ls stories/examples/*.lua 1> /dev/null 2>&1; then
          for story in stories/examples/*.lua; do
            echo "Validating $story..."
            lua bin/whisker --validate "$story"
          done
        else
          echo "No .lua story files found in stories/examples/"
          echo "Skipping validation"
        fi
