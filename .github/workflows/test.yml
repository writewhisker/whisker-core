name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test on ${{ matrix.os }} with Lua ${{ matrix.lua-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        lua-version: ['5.1', '5.2', '5.3', '5.4', 'luajit']

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Lua
      uses: leafo/gh-actions-lua@v12
      with:
        luaVersion: ${{ matrix.lua-version }}

    - name: Setup LuaRocks
      uses: leafo/gh-actions-luarocks@v6

    - name: Install busted
      run: luarocks install busted

    - name: Install luacov (coverage)
      run: luarocks install luacov

    - name: Run tests
      run: busted --verbose --coverage

    - name: Generate coverage report
      if: matrix.lua-version == '5.4' && matrix.os == 'ubuntu-latest'
      run: luacov

    - name: Check coverage threshold
      if: matrix.lua-version == '5.4' && matrix.os == 'ubuntu-latest'
      run: |
        # Extract total coverage percentage from luacov report
        COVERAGE=$(grep -E "^Total" luacov.report.out | awk '{print $2}' | tr -d '%')
        echo "Total coverage: ${COVERAGE}%"

        # Minimum overall coverage threshold (80%)
        MIN_COVERAGE=80

        if [ -z "$COVERAGE" ]; then
          echo "Warning: Could not parse coverage percentage"
          exit 0
        fi

        # Compare as integers
        COVERAGE_INT=${COVERAGE%.*}
        if [ "$COVERAGE_INT" -lt "$MIN_COVERAGE" ]; then
          echo "Coverage ${COVERAGE}% is below minimum threshold of ${MIN_COVERAGE}%"
          exit 1
        fi

        echo "Coverage ${COVERAGE}% meets minimum threshold of ${MIN_COVERAGE}%"

    - name: Upload coverage
      if: matrix.lua-version == '5.4' && matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v5
      with:
        files: ./luacov.report.out
        flags: unittests
        name: codecov-whisker-core

  lint:
    name: Lint with LuaCheck
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Lua
      uses: leafo/gh-actions-lua@v12
      with:
        luaVersion: '5.4'

    - name: Setup LuaRocks
      uses: leafo/gh-actions-luarocks@v6

    - name: Install luacheck
      run: luarocks install luacheck

    - name: Run luacheck
      run: luacheck lib/ bin/ --config .luacheckrc

  validate:
    name: Validate story examples
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Lua
      uses: leafo/gh-actions-lua@v12
      with:
        luaVersion: '5.4'

    - name: Validate example stories
      run: |
        if ls stories/examples/*.lua 1> /dev/null 2>&1; then
          for story in stories/examples/*.lua; do
            echo "Validating $story..."
            lua bin/whisker --validate "$story"
          done
        else
          echo "No .lua story files found in stories/examples/"
          echo "Skipping validation"
        fi
