<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Museum Tour - Whisker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Styles -->
    <link rel="stylesheet" href="museum.css">

    <style>
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-icon {
            font-size: 4rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            margin-top: 1rem;
            font-weight: 600;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-icon">üèõÔ∏è</div>
        <div class="loading-text">Loading Museum Tour...</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Main App -->
    <div id="museum-app" class="museum-app" style="display: none;">
        <!-- Header -->
        <header class="museum-header">
            <div class="museum-header-content">
                <button class="museum-btn museum-btn-icon" id="btn-menu" aria-label="Menu">
                    <span class="icon">‚ò∞</span>
                </button>

                <div class="museum-title-section">
                    <h1 class="museum-title" id="tour-title">Museum Tour</h1>
                    <p class="museum-subtitle" id="tour-subtitle"></p>
                </div>

                <button class="museum-btn museum-btn-icon" id="btn-map" aria-label="Map">
                    <span class="icon">üó∫Ô∏è</span>
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="museum-progress">
                <div class="museum-progress-bar" id="progress-bar" style="width: 0%"></div>
                <div class="museum-progress-text" id="progress-text">0/0 exhibits</div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="museum-main">
            <!-- Passage Content -->
            <div class="museum-passage" id="passage-container">
                <h2 class="passage-title" id="passage-title">Loading...</h2>

                <!-- Metadata (audio, floor, etc.) -->
                <div class="passage-metadata" id="passage-metadata"></div>

                <!-- Passage Content -->
                <div class="passage-content" id="passage-content">
                    <p>Please wait...</p>
                </div>

                <!-- Choices -->
                <div class="passage-choices" id="passage-choices"></div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="museum-bottom-nav">
            <button class="nav-btn" id="btn-qr">
                <span class="nav-icon">üî≤</span>
                <span class="nav-label">QR Scan</span>
            </button>

            <button class="nav-btn" id="btn-audio">
                <span class="nav-icon">üéß</span>
                <span class="nav-label">Audio</span>
            </button>

            <button class="nav-btn" id="btn-stats">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Stats</span>
            </button>

            <button class="nav-btn" id="btn-help">
                <span class="nav-icon">‚ùì</span>
                <span class="nav-label">Help</span>
            </button>
        </nav>

        <!-- Audio Player (hidden by default) -->
        <div class="audio-player" id="audio-player" style="display: none;">
            <div class="audio-player-content">
                <div class="audio-info">
                    <div class="audio-title" id="audio-title">Audio Guide</div>
                    <div class="audio-duration" id="audio-duration">0:00 / 0:00</div>
                </div>

                <audio id="audio-element" preload="metadata"></audio>

                <div class="audio-controls">
                    <button class="audio-btn" id="audio-rewind" aria-label="Rewind 15s">
                        <span class="icon">‚è™</span>
                    </button>

                    <button class="audio-btn audio-btn-large" id="audio-play-pause" aria-label="Play/Pause">
                        <span class="icon" id="audio-play-icon">‚ñ∂Ô∏è</span>
                    </button>

                    <button class="audio-btn" id="audio-forward" aria-label="Forward 15s">
                        <span class="icon">‚è©</span>
                    </button>

                    <button class="audio-btn" id="audio-close" aria-label="Close">
                        <span class="icon">‚úï</span>
                    </button>
                </div>

                <div class="audio-seek">
                    <input type="range" id="audio-seek-bar" min="0" max="100" value="0" step="0.1">
                </div>
            </div>
        </div>

        <!-- Modals -->

        <!-- Map Modal -->
        <div class="museum-modal" id="map-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Museum Map</h2>
                    <button class="modal-close" id="map-modal-close" aria-label="Close">‚úï</button>
                </div>
                <div class="modal-body" id="map-container">
                    <!-- Map will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- QR Scanner Modal -->
        <div class="museum-modal" id="qr-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Scan QR Code</h2>
                    <button class="modal-close" id="qr-modal-close" aria-label="Close">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="qr-scanner-container">
                        <div id="qr-reader"></div>

                        <div class="qr-manual-entry">
                            <p>Or enter QR code manually:</p>
                            <input type="text" id="qr-input" placeholder="MUSEUM-DINO-001" class="qr-input">
                            <button class="museum-btn museum-btn-primary" id="qr-submit">Go to Exhibit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Modal -->
        <div class="museum-modal" id="stats-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Visit Statistics</h2>
                    <button class="modal-close" id="stats-modal-close" aria-label="Close">‚úï</button>
                </div>
                <div class="modal-body" id="stats-container">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div class="museum-modal" id="help-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">How to Use</h2>
                    <button class="modal-close" id="help-modal-close" aria-label="Close">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="help-section">
                        <h3>üó∫Ô∏è Navigation</h3>
                        <p>Tap on exhibit choices to navigate through the museum. You can visit exhibits in any order.</p>
                    </div>

                    <div class="help-section">
                        <h3>üî≤ QR Codes</h3>
                        <p>Scan QR codes on exhibit labels to jump directly to that exhibit. Grant camera permission when prompted.</p>
                    </div>

                    <div class="help-section">
                        <h3>üéß Audio Guides</h3>
                        <p>Many exhibits have audio guides. Tap the audio button to listen. Use headphones for the best experience.</p>
                    </div>

                    <div class="help-section">
                        <h3>üìä Progress</h3>
                        <p>Track your visit progress with the stats dashboard. See which exhibits you've visited.</p>
                    </div>

                    <div class="help-section">
                        <h3>üì¥ Offline Mode</h3>
                        <p>This tour works offline! After first load, you can use it without internet connection.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Modal -->
        <div class="museum-modal" id="menu-modal">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Menu</h2>
                    <button class="modal-close" id="menu-modal-close" aria-label="Close">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="menu-options">
                        <button class="menu-option" id="menu-restart">
                            <span class="menu-icon">üîÑ</span>
                            <span class="menu-text">Restart Tour</span>
                        </button>

                        <button class="menu-option" id="menu-language">
                            <span class="menu-icon">üåê</span>
                            <span class="menu-text">Language</span>
                        </button>

                        <button class="menu-option" id="menu-export">
                            <span class="menu-icon">üíæ</span>
                            <span class="menu-text">Export Visit Data</span>
                        </button>

                        <button class="menu-option" id="menu-about">
                            <span class="menu-icon">‚ÑπÔ∏è</span>
                            <span class="menu-text">About</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="museum-client.js"></script>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('‚úÖ Service Worker registered'))
                    .catch(err => console.log('‚ùå Service Worker registration failed:', err));
            });
        }

        // Initialize museum client
        const museumClient = new MuseumClient();

        // Load story (for demo, load from example)
        const storyPath = '../museum_tours/natural_history/story.whisker';

        fetch(storyPath)
            .then(response => response.json())
            .then(story => {
                museumClient.loadStory(story);
                museumClient.start();

                // Hide loading screen
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('museum-app').style.display = 'flex';
            })
            .catch(error => {
                console.error('Failed to load story:', error);
                document.querySelector('.loading-text').textContent = 'Failed to load tour. Please refresh.';
            });
    </script>
</body>
</html>
