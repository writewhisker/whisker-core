<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisker - The Enchanted Forest (Web Demo)</title>
    <!-- Fengari: Lua VM for JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/fengari-web@0.1.4/dist/fengari-web.js"></script>
    <link rel="stylesheet" href="../../src/runtime/web_runtime.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f5f5;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            flex-direction: column;
            gap: 2rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #667eea;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .lua-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .lua-indicator::before {
            content: '🌙';
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Lua Indicator -->
    <div class="lua-indicator">Lua Runtime Active</div>

    <!-- Loading indicator -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Whisker Interactive Fiction...</div>
    </div>

    <!-- Whisker container (hidden until loaded) -->
    <div id="whisker-container" style="display: none;"></div>

    <script>
        // Example story - The Enchanted Forest
        const STORY_DATA = {
            title: "The Enchanted Forest",
            author: "Whisker Web Demo",
            variables: {
                player_name: "Adventurer",
                gold: 0,
                health: 100,
                magic: 50,
                has_key: false,
                forest_level: 1,
                discoveries: 0
            },
            start: "forest_entrance",
            passages: [
                {
                    id: "forest_entrance",
                    title: "The Forest Entrance",
                    content: "Welcome, **{{player_name}}**!\n\nYou stand before an ancient, mystical forest. Towering trees seem to whisper secrets, and magical lights dance between the branches. A worn path leads deeper into the woods.\n\n**Your Status:**\n• Health: {{health}}\n• Magic: {{magic}}\n• Gold: {{gold}} coins\n• Discoveries: {{discoveries}}\n\nWhat will you do?",
                    choices: [
                        {
                            text: "🌲 Enter the forest",
                            target: "deep_forest"
                        },
                        {
                            text: "🔍 Search the entrance area",
                            target: "search_entrance"
                        },
                        {
                            text: "🧘 Meditate and restore magic",
                            target: "meditate"
                        }
                    ]
                },
                {
                    id: "search_entrance",
                    title: "Searching the Entrance",
                    content: "You carefully search around the forest entrance. Your thorough exploration reveals:\n\n• **30 gold coins** hidden under a moss-covered rock\n• **Healing herbs** that restore 15 health\n• **A mysterious glowing mushroom** that increases your magic by 10\n\n*Discovery made! Total discoveries: {{discoveries}}*",
                    script: "set('gold', get('gold') + 30); set('health', Math.min(100, get('health') + 15)); set('magic', Math.min(100, get('magic') + 10)); set('discoveries', get('discoveries') + 1)",
                    choices: [
                        {
                            text: "Continue exploring",
                            target: "forest_entrance"
                        }
                    ]
                },
                {
                    id: "meditate",
                    title: "Peaceful Meditation",
                    content: "You sit cross-legged and enter a meditative state. The forest's ambient magic flows through you, restoring your inner power.\n\n**Magic fully restored to 100!**\n\nYou also gain clarity and feel healthier. **+20 Health**",
                    script: "set('magic', 100); set('health', Math.min(100, get('health') + 20))",
                    choices: [
                        {
                            text: "Continue your journey",
                            target: "forest_entrance"
                        }
                    ]
                },
                {
                    id: "deep_forest",
                    title: "Deep in the Forest",
                    content: "The forest path winds through ancient trees. You hear mysterious sounds—rustling leaves, distant chimes, and ethereal whispers.\n\nAhead, you see:\n• A glowing **fairy circle** to the left\n• A massive **ancient tree** with a door straight ahead\n• A shimmering **magic fountain** to the right",
                    choices: [
                        {
                            text: "✨ Approach the fairy circle",
                            target: "fairy_circle"
                        },
                        {
                            text: "🌳 Examine the ancient tree",
                            target: "ancient_tree"
                        },
                        {
                            text: "⛲ Visit the magic fountain",
                            target: "magic_fountain"
                        },
                        {
                            text: "↩️ Return to entrance",
                            target: "forest_entrance"
                        }
                    ]
                },
                {
                    id: "magic_fountain",
                    title: "The Magic Fountain",
                    content: "You approach a beautiful fountain made of crystal that pulses with magical energy. The water sparkles with an otherworldly glow.\n\nYou drink from the fountain and feel power surge through you!\n\n**+30 Magic Power**\n**+25 Health**\n**+1 Discovery**\n\nA voice whispers: *'The pure of heart shall be rewarded.'*",
                    script: "set('magic', Math.min(100, get('magic') + 30)); set('health', Math.min(100, get('health') + 25)); set('discoveries', get('discoveries') + 1)",
                    choices: [
                        {
                            text: "Continue exploring",
                            target: "deep_forest"
                        }
                    ]
                },
                {
                    id: "fairy_circle",
                    title: "The Fairy Circle",
                    content: "You step into a ring of luminous mushrooms. The air shimmers and a beautiful fairy materializes before you.\n\n*'Greetings, brave one!'* she says in a voice like bells. *'I offer you a **Golden Key** that opens the Ancient Tree. The price is **25 gold coins**.'*\n\n**Your gold: {{gold}} coins**",
                    choices: [
                        {
                            text: "💰 Buy the Golden Key (25 gold)",
                            target: "bought_key",
                            condition: "gold >= 25",
                            script: "set('gold', get('gold') - 25); set('has_key', true)"
                        },
                        {
                            text: "🔮 Offer magic instead (40 magic)",
                            target: "magic_trade",
                            condition: "magic >= 40 && has_key === false",
                            script: "set('magic', get('magic') - 40); set('has_key', true)"
                        },
                        {
                            text: "😊 Politely decline",
                            target: "deep_forest"
                        },
                        {
                            text: "💸 Not enough gold...",
                            target: "deep_forest",
                            condition: "gold < 25"
                        }
                    ]
                },
                {
                    id: "bought_key",
                    title: "The Golden Key",
                    content: "The fairy hands you an ornate golden key that glows with inner light.\n\n*'Use it wisely, brave one,'* she whispers before vanishing in a shower of sparkles.\n\n**Golden Key obtained!**",
                    choices: [
                        {
                            text: "Continue your quest",
                            target: "ancient_tree"
                        }
                    ]
                },
                {
                    id: "magic_trade",
                    title: "A Magical Exchange",
                    content: "The fairy's eyes light up with interest.\n\n*'Your magical essence! How generous! This is worth far more than gold to us.'*\n\nShe hands you the **Golden Key** and touches your forehead. You feel a surge of magical knowledge!\n\n**Golden Key obtained!**\n**+15 Magic (knowledge gift)**",
                    script: "set('magic', Math.min(100, get('magic') + 15))",
                    choices: [
                        {
                            text: "Continue your quest",
                            target: "ancient_tree"
                        }
                    ]
                },
                {
                    id: "ancient_tree",
                    title: "The Ancient Tree",
                    content: "You stand before a colossal oak tree with a mysterious door carved into its trunk. The door has a golden keyhole and is covered in glowing runes.\n\nPowerful magic emanates from within.",
                    choices: [
                        {
                            text: "🔑 Use the Golden Key",
                            target: "treasure_room",
                            condition: "has_key === true"
                        },
                        {
                            text: "🔮 Cast opening spell (60 magic)",
                            target: "magic_open",
                            condition: "magic >= 60 && has_key === false",
                            script: "set('magic', get('magic') - 60)"
                        },
                        {
                            text: "💪 Try to force the door",
                            target: "force_door",
                            condition: "has_key === false"
                        },
                        {
                            text: "📖 Study the runes",
                            target: "study_runes"
                        },
                        {
                            text: "↩️ Leave",
                            target: "deep_forest"
                        }
                    ]
                },
                {
                    id: "study_runes",
                    title: "Ancient Knowledge",
                    content: "You study the glowing runes carefully. Though written in an ancient language, their meaning becomes clear:\n\n**'Seek the guardians of the mushroom ring,\nTrade gold or magic for the key they bring.\nOnly with the key or powerful spell,\nMay one enter where the treasures dwell.'**\n\nYou've learned the secret! **+1 Discovery**",
                    script: "set('discoveries', get('discoveries') + 1)",
                    choices: [
                        {
                            text: "Continue exploring",
                            target: "deep_forest"
                        }
                    ]
                },
                {
                    id: "magic_open",
                    title: "Magical Prowess",
                    content: "You channel your magical energy into a powerful opening spell. The runes flare brilliantly and the ancient door slowly swings open!\n\n*'Impressive, young mage,'* the tree whispers.\n\n**-60 Magic used**\n**+2 Discoveries for magical skill**",
                    script: "set('discoveries', get('discoveries') + 2)",
                    choices: [
                        {
                            text: "Enter the treasure room",
                            target: "treasure_room"
                        }
                    ]
                },
                {
                    id: "force_door",
                    title: "A Futile Attempt",
                    content: "You push, pull, and strike the door with all your might, but it doesn't budge even slightly. The ancient wood is harder than steel.\n\nYour efforts exhaust you:\n• **-15 Health**\n• **-20 Magic**\n\nThe tree whispers: *'Brute force will not prevail. Seek the key or master magic.'*",
                    script: "set('health', Math.max(0, get('health') - 15)); set('magic', Math.max(0, get('magic') - 20))",
                    choices: [
                        {
                            text: "Search for another way",
                            target: "deep_forest"
                        }
                    ]
                },
                {
                    id: "treasure_room",
                    title: "The Legendary Treasure!",
                    content: "The door opens to reveal a chamber filled with wonders!\n\n**🏆 TREASURE FOUND:**\n• 💰 **300 gold coins**\n• 💎 **Eternal Crystal** (+50 permanent magic)\n• ❤️ **Heart of the Forest** (full health)\n• 👑 **Crown of Champions**\n\n**🎉 VICTORY! 🎉**\n\n**Final Statistics:**\n• Health: 100\n• Magic: 100\n• Gold: {{gold}} coins\n• Discoveries: {{discoveries}}\n\nThe forest will remember your bravery, **{{player_name}}**!",
                    script: "set('gold', get('gold') + 300); set('magic', 100); set('health', 100); set('discoveries', get('discoveries') + 1)",
                    choices: [
                        {
                            text: "🎮 Start New Adventure",
                            target: "forest_entrance"
                        }
                    ]
                }
            ]
        };

        // Lua-Enabled Whisker Player
        class LuaWhiskerPlayer {
            constructor() {
                this.story = null;
                this.currentPassage = null;
                this.variables = {};
                this.visited = {};
                this.history = [];
                this.maxHistory = 50;
                this.luaState = null;
                this.initializeLua();
            }

            initializeLua() {
                if (typeof fengari === 'undefined') {
                    console.error('Fengari not loaded!');
                    return;
                }

                // Initialize Fengari Lua state
                const lua = fengari.lua;
                const lauxlib = fengari.lauxlib;
                const lualib = fengari.lualib;

                this.luaState = lauxlib.luaL_newstate();
                lualib.luaL_openlibs(this.luaState);

                console.log('✅ Lua runtime initialized with Fengari');
            }

            loadStory(storyData) {
                this.story = storyData;
                this.variables = {...(storyData.variables || {})};
                document.getElementById('story-title').textContent = storyData.title || 'Whisker Story';

                const authorEl = document.getElementById('story-author');
                if (storyData.author) {
                    authorEl.textContent = 'by ' + storyData.author;
                    authorEl.style.display = 'block';
                } else {
                    authorEl.style.display = 'none';
                }

                this.updateStats();
            }

            start() {
                if (!this.story) {
                    console.error('No story loaded');
                    return;
                }

                const startPassage = this.story.start || this.story.passages[0].id;
                this.goToPassage(startPassage);
            }

            goToPassage(passageId, saveHistory = true) {
                const passage = this.story.passages.find(p => p.id === passageId);

                if (!passage) {
                    console.error('Passage not found:', passageId);
                    return;
                }

                if (saveHistory && this.currentPassage) {
                    this.history.push({
                        passageId: this.currentPassage.id,
                        variables: {...this.variables},
                        visited: {...this.visited}
                    });

                    if (this.history.length > this.maxHistory) {
                        this.history.shift();
                    }
                }

                this.currentPassage = passage;
                this.visited[passageId] = (this.visited[passageId] || 0) + 1;

                if (passage.script) {
                    this.executeScript(passage.script);
                }

                this.render();
                this.updateProgress();
                this.updateHistory();
            }

            render() {
                const passage = this.currentPassage;

                document.getElementById('passage-title').innerHTML = this.processInline(passage.title || '');

                const content = this.processContent(passage.content);
                document.getElementById('passage-content').innerHTML = content;

                const choicesContainer = document.getElementById('choices-container');
                choicesContainer.innerHTML = '';

                if (passage.choices && passage.choices.length > 0) {
                    passage.choices.forEach(choice => {
                        if (this.evaluateCondition(choice.condition)) {
                            const btn = document.createElement('button');
                            btn.className = 'choice-btn';
                            btn.innerHTML = this.processInline(choice.text);
                            btn.onclick = () => {
                                if (choice.script) {
                                    this.executeScript(choice.script);
                                }
                                this.goToPassage(choice.target);
                            };
                            choicesContainer.appendChild(btn);
                        }
                    });
                }

                this.updateStats();
            }

            executeLuaCode(code) {
                if (!this.luaState || typeof fengari === 'undefined') {
                    console.error('Lua not available');
                    return;
                }

                try {
                    const lua = fengari.lua;
                    const lauxlib = fengari.lauxlib;
                    const to_jsstring = fengari.to_jsstring;

                    // Create game_state table with get/set methods
                    const luaCode = `
                        game_state = {
                            data = {},
                            set = function(self, key, value)
                                self.data[key] = value
                                js_set_variable(key, value)
                            end,
                            get = function(self, key)
                                return js_get_variable(key)
                            end
                        }

                        -- User code
                        ${code}
                    `;

                    // Register JavaScript callbacks
                    const L = this.luaState;

                    // js_set_variable callback
                    lua.lua_pushcfunction(L, (L) => {
                        const key = to_jsstring(lua.lua_tostring(L, -2));
                        const value = lua.lua_tonumber(L, -1) !== null ?
                            lua.lua_tonumber(L, -1) :
                            (lua.lua_toboolean(L, -1) ?
                                lua.lua_toboolean(L, -1) :
                                to_jsstring(lua.lua_tostring(L, -1)));

                        this.variables[key] = value;
                        return 0;
                    });
                    lua.lua_setglobal(L, to_jsstring("js_set_variable"));

                    // js_get_variable callback
                    lua.lua_pushcfunction(L, (L) => {
                        const key = to_jsstring(lua.lua_tostring(L, -1));
                        const value = this.variables[key];

                        if (typeof value === 'number') {
                            lua.lua_pushnumber(L, value);
                        } else if (typeof value === 'boolean') {
                            lua.lua_pushboolean(L, value);
                        } else if (typeof value === 'string') {
                            lua.lua_pushstring(L, to_jsstring(value));
                        } else {
                            lua.lua_pushnil(L);
                        }

                        return 1;
                    });
                    lua.lua_setglobal(L, to_jsstring("js_get_variable"));

                    // Execute Lua code
                    lauxlib.luaL_dostring(L, to_jsstring(luaCode));

                    console.log('✅ Lua code executed successfully');
                } catch (error) {
                    console.error('❌ Lua execution error:', error);
                }
            }

            processInline(content) {
                if (!content) return '';

                // Process {{lua:}} blocks FIRST
                content = content.replace(/\{\{lua:([\s\S]*?)\}\}/g, (match, code) => {
                    this.executeLuaCode(code.trim());
                    return ''; // Lua blocks don't output text
                });

                // Process {{#if}}...{{/if}} conditionals
                content = this.processConditionals(content);

                // Process {{variable}} expressions
                content = content.replace(/\{\{([a-zA-Z_][a-zA-Z0-9_]*)\}\}/g, (match, varName) => {
                    varName = varName.trim();
                    if (this.variables.hasOwnProperty(varName)) {
                        return String(this.variables[varName]);
                    }
                    return `<span style="color: #ef4444;">[${varName}]</span>`;
                });

                // Process markdown
                content = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                content = content.replace(/\*(.+?)\*/g, '<em>$1</em>');

                return content;
            }

            processConditionals(content) {
                let maxIterations = 100;
                let iteration = 0;

                while (content.includes('{{#if') && iteration < maxIterations) {
                    iteration++;

                    const ifMatch = content.match(/\{\{#if\s+([^}]+)\}\}/);
                    if (!ifMatch) break;

                    const ifStart = ifMatch.index;
                    const ifEnd = ifStart + ifMatch[0].length;
                    const condition = ifMatch[1];

                    const endifMatch = content.substring(ifEnd).match(/\{\{\/if\}\}/);
                    if (!endifMatch) break;

                    const endifStart = ifEnd + endifMatch.index;
                    const endifEnd = endifStart + endifMatch[0].length;
                    const blockContent = content.substring(ifEnd, endifStart);

                    // Parse else if / else
                    const blocks = this.parseConditionalBlocks(blockContent, condition);

                    let replacement = '';
                    for (const block of blocks) {
                        if (block.condition === null || this.evaluateCondition(block.condition)) {
                            replacement = block.content;
                            break;
                        }
                    }

                    content = content.substring(0, ifStart) + replacement + content.substring(endifEnd);
                }

                return content;
            }

            parseConditionalBlocks(blockContent, initialCondition) {
                const blocks = [{condition: initialCondition, content: ''}];
                let currentBlock = 0;
                let pos = 0;

                while (pos < blockContent.length) {
                    const elseIfMatch = blockContent.substring(pos).match(/\{\{else if\s+([^}]+)\}\}/);
                    const elseMatch = blockContent.substring(pos).match(/\{\{else\}\}/);

                    let nextPos = blockContent.length;
                    let newCondition = null;

                    if (elseIfMatch && (!elseMatch || elseIfMatch.index < elseMatch.index)) {
                        blocks[currentBlock].content = blockContent.substring(0, pos + elseIfMatch.index);
                        newCondition = elseIfMatch[1];
                        nextPos = pos + elseIfMatch.index + elseIfMatch[0].length;
                    } else if (elseMatch) {
                        blocks[currentBlock].content = blockContent.substring(0, pos + elseMatch.index);
                        newCondition = null;
                        nextPos = pos + elseMatch.index + elseMatch[0].length;
                    } else {
                        blocks[currentBlock].content = blockContent.substring(pos);
                        break;
                    }

                    blocks.push({condition: newCondition, content: ''});
                    currentBlock++;
                    blockContent = blockContent.substring(nextPos);
                    pos = 0;
                }

                return blocks;
            }

            processContent(content) {
                if (!content) return '';

                content = this.processInline(content);

                const paragraphs = content.split(/\n\n+/).filter(p => p.trim());
                content = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');

                return content;
            }

            executeScript(script) {
                try {
                    const context = {
                        set: (key, value) => { this.variables[key] = value; },
                        get: (key, defaultValue = null) => this.variables[key] !== undefined ? this.variables[key] : defaultValue,
                        visited: (passageId) => this.visited[passageId] || 0,
                        random: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
                        Math: Math
                    };

                    const func = new Function('context', `with(context) { ${script} }`);
                    func(context);
                    this.updateStats();
                } catch (error) {
                    console.error('Script execution error:', error);
                }
            }

            evaluateCondition(condition) {
                if (!condition) return true;

                try {
                    const context = {
                        ...this.variables,
                        visited: (passageId) => this.visited[passageId] || 0
                    };

                    const func = new Function('context', `with(context) { return ${condition}; }`);
                    return func(context);
                } catch (error) {
                    console.error('Condition evaluation error:', error);
                    return true;
                }
            }

            updateStats() {
                const container = document.getElementById('stats-container');
                container.innerHTML = '';

                for (const [key, value] of Object.entries(this.variables)) {
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';
                    statItem.innerHTML = `
                        <span class="stat-label">${key}</span>
                        <span class="stat-value">${value}</span>
                    `;
                    container.appendChild(statItem);
                }
            }

            updateProgress() {
                const totalPassages = this.story.passages.length;
                const visitedCount = Object.keys(this.visited).length;
                const percentage = (visitedCount / totalPassages) * 100;
                document.getElementById('progress-bar').style.width = percentage + '%';
            }

            updateHistory() {
                const container = document.getElementById('history-container');
                const recentHistory = this.history.slice(-5).reverse();

                container.innerHTML = '';

                recentHistory.forEach(entry => {
                    const passage = this.story.passages.find(p => p.id === entry.passageId);
                    if (passage) {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        item.textContent = passage.title || passage.id;
                        container.appendChild(item);
                    }
                });
            }

            undo() {
                if (this.history.length === 0) {
                    this.showNotification('No more history', 'info');
                    return;
                }

                const previousState = this.history.pop();
                this.variables = {...previousState.variables};
                this.visited = {...previousState.visited};
                this.goToPassage(previousState.passageId, false);
                this.showNotification('Undone', 'success');
            }

            restart() {
                if (confirm('Are you sure you want to restart the story?')) {
                    this.variables = {...(this.story.variables || {})};
                    this.visited = {};
                    this.history = [];
                    this.start();
                    this.showNotification('Story restarted', 'info');
                }
            }

            showSaveModal() {
                const saveData = {
                    passageId: this.currentPassage.id,
                    variables: this.variables,
                    visited: this.visited,
                    history: this.history,
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('whisker_save', JSON.stringify(saveData));
                this.showNotification('Game saved', 'success');
            }

            showLoadModal() {
                const saveData = localStorage.getItem('whisker_save');

                if (!saveData) {
                    this.showNotification('No save found', 'error');
                    return;
                }

                const data = JSON.parse(saveData);
                this.variables = data.variables;
                this.visited = data.visited;
                this.history = data.history;
                this.goToPassage(data.passageId, false);
                this.showNotification('Game loaded', 'success');
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Initialize player when page loads
        window.addEventListener('DOMContentLoaded', () => {
            // Hide loading, show container
            document.getElementById('loading').style.display = 'none';
            document.getElementById('whisker-container').style.display = 'block';

            // Create and start player
            window.whiskerPlayer = new LuaWhiskerPlayer();
            window.whiskerPlayer.loadStory(STORY_DATA);
            window.whiskerPlayer.start();

            console.log('🌙 Whisker Lua Runtime loaded successfully!');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    window.whiskerPlayer.showSaveModal();
                } else if (e.key === 'z') {
                    e.preventDefault();
                    window.whiskerPlayer.undo();
                } else if (e.key === 'l') {
                    e.preventDefault();
                    window.whiskerPlayer.showLoadModal();
                }
            }
        });
    </script>
</body>
</html>